package com.rover.controller\n\nimport com.google.gson.Gson\nimport com.google.gson.JsonObject\nimport kotlinx.coroutines.*\nimport timber.log.Timber\n\n/**\n * Motor controller for sending control commands to the rover\n */\nclass MotorController(\n    private val webRTCManager: com.rover.webrtc.WebRTCManager\n) {\n    private val gson = Gson()\n    private val coroutineScope = CoroutineScope(Dispatchers.Default + Job())\n    \n    // Current state\n    private var currentSpeed = 0\n    private var currentDirection = MotorDirection.STOP\n    \n    enum class MotorDirection {\n        FORWARD, BACKWARD, LEFT, RIGHT, STOP\n    }\n    \n    /**\n     * Move rover forward\n     */\n    fun moveForward(speed: Int = 200) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"forward\")\n            addProperty(\"speed\", speed.coerceIn(0, 255))\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = speed\n        currentDirection = MotorDirection.FORWARD\n    }\n    \n    /**\n     * Move rover backward\n     */\n    fun moveBackward(speed: Int = 200) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"backward\")\n            addProperty(\"speed\", speed.coerceIn(0, 255))\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = speed\n        currentDirection = MotorDirection.BACKWARD\n    }\n    \n    /**\n     * Turn rover left\n     */\n    fun turnLeft(speed: Int = 150) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"left\")\n            addProperty(\"speed\", speed.coerceIn(0, 255))\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = speed\n        currentDirection = MotorDirection.LEFT\n    }\n    \n    /**\n     * Turn rover right\n     */\n    fun turnRight(speed: Int = 150) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"right\")\n            addProperty(\"speed\", speed.coerceIn(0, 255))\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = speed\n        currentDirection = MotorDirection.RIGHT\n    }\n    \n    /**\n     * Stop rover\n     */\n    fun stop() {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"stop\")\n            addProperty(\"speed\", 0)\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = 0\n        currentDirection = MotorDirection.STOP\n    }\n    \n    /**\n     * Emergency stop\n     */\n    fun emergencyStop() {\n        Timber.w(\"Emergency stop activated\")\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"system\")\n            addProperty(\"action\", \"emergency_stop\")\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n        currentSpeed = 0\n        currentDirection = MotorDirection.STOP\n    }\n    \n    /**\n     * Set individual motor speeds\n     */\n    fun setMotorSpeed(leftSpeed: Int, rightSpeed: Int) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"motor\")\n            addProperty(\"action\", \"set_speed\")\n            addProperty(\"left_speed\", leftSpeed.coerceIn(-255, 255))\n            addProperty(\"right_speed\", rightSpeed.coerceIn(-255, 255))\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n    }\n    \n    /**\n     * Send camera control command\n     */\n    fun switchCamera(camera: String) {\n        val command = JsonObject().apply {\n            addProperty(\"type\", \"camera\")\n            addProperty(\"action\", \"switch_$camera\")\n            addProperty(\"timestamp\", System.currentTimeMillis())\n        }\n        sendCommand(command)\n    }\n    \n    /**\n     * Send generic command\n     */\n    fun sendCustomCommand(command: JsonObject) {\n        sendCommand(command)\n    }\n    \n    /**\n     * Get current state\n     */\n    fun getCurrentState(): ControllerState {\n        return ControllerState(\n            speed = currentSpeed,\n            direction = currentDirection,\n            timestamp = System.currentTimeMillis()\n        )\n    }\n    \n    /**\n     * Send command to rover via WebRTC data channel\n     */\n    private fun sendCommand(command: JsonObject) {\n        try {\n            val commandJson = gson.toJson(command)\n            webRTCManager.sendControlCommand(commandJson)\n            Timber.d(\"Command sent: $commandJson\")\n        } catch (e: Exception) {\n            Timber.e(e, \"Error sending command\")\n        }\n    }\n    \n    fun shutdown() {\n        coroutineScope.cancel()\n    }\n    \n    data class ControllerState(\n        val speed: Int,\n        val direction: MotorDirection,\n        val timestamp: Long\n    )\n}\n
